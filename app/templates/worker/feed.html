{% extends "base.html" %}

{% block title %}–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤{% endblock %}

{% block content %}
<div class="flex flex-col h-screen overflow-hidden bg-gray-50 dark:bg-gray-900 relative">
    
    <div class="px-4 py-3 flex justify-between items-center z-10">
        <h1 class="text-xl font-bold text-tg_text">–õ–µ–Ω—Ç–∞ –∑–∞–∫–∞–∑–æ–≤</h1>
        <div class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-bold">–í–∞—à–∞ —Ä–æ–ª—å: –ú–∞—Å—Ç–µ—Ä</div>
    </div>

    <div id="card-stack" class="flex-1 relative mx-4 mb-24 mt-2">
        <div id="no-orders" class="hidden absolute inset-0 flex flex-col items-center justify-center text-center">
            <div class="text-6xl mb-4">üéâ</div>
            <h3 class="text-xl font-bold text-tg_text">–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h3>
            <button onclick="location.reload()" class="mt-6 px-6 py-2 bg-blue-500 text-white rounded-xl">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div id="loading" class="absolute inset-0 bg-white dark:bg-gray-800 rounded-3xl shadow-lg border border-gray-200 dark:border-gray-700 p-6 animate-pulse">
            <div class="h-64 bg-gray-200 dark:bg-gray-700 rounded-xl mb-4"></div>
        </div>
    </div>

    <div class="fixed bottom-6 left-0 right-0 px-8 flex justify-center space-x-6 z-20">
        <button onclick="handleSkip()" class="w-16 h-16 rounded-full bg-white dark:bg-gray-800 shadow-xl border border-red-100 text-red-500 flex items-center justify-center text-3xl hover:scale-110 transition-transform active:scale-95">‚ùå</button>
        <button onclick="openApplyModal()" class="w-16 h-16 rounded-full bg-blue-500 shadow-xl shadow-blue-500/30 text-white flex items-center justify-center text-3xl hover:scale-110 transition-transform active:scale-95">‚úÖ</button>
    </div>

    <div id="apply-modal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm transition-opacity">
        <div class="bg-white dark:bg-gray-800 w-full max-w-md p-6 rounded-t-3xl sm:rounded-2xl shadow-2xl transform transition-transform translate-y-0">
            
            <h3 class="text-xl font-bold text-tg_text mb-4">–í–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</h3>
            
            <label class="block text-sm text-gray-500 mb-1">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ —Ü–µ–Ω—É (‚ÇΩ)</label>
            <input id="input-price" type="number" class="w-full p-3 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl text-lg font-bold text-tg_text focus:ring-2 focus:ring-blue-500 outline-none mb-4">
            
            <label class="block text-sm text-gray-500 mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–ª–∏–µ–Ω—Ç—É</label>
            <textarea id="input-message" rows="3" placeholder="–ü—Ä–∏–µ–¥—É —á–µ—Ä–µ–∑ —á–∞—Å, –µ—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã..." class="w-full p-3 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl text-tg_text focus:ring-2 focus:ring-blue-500 outline-none mb-6"></textarea>
            
            <div class="flex space-x-3">
                <button onclick="closeModal()" class="flex-1 py-3 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-xl font-medium">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="submitApplication()" class="flex-1 py-3 bg-blue-500 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        let ordersQueue = [];
        let currentOrder = null;

        // --- –§–£–ù–ö–¶–ò–ò –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê ---
        
        // 1. –û—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –≥–∞–ª–æ—á–∫–∏
        window.openApplyModal = function() {
            if (!currentOrder) return;
            
            // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è–µ–º —Ü–µ–Ω—É –∏–∑ –∑–∞–∫–∞–∑–∞
            document.getElementById('input-price').value = currentOrder.price;
            document.getElementById('input-message').value = "–ì–æ—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–∫–∞–∑!";
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ
            document.getElementById('apply-modal').classList.remove('hidden');
        }

        // 2. –ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ
        window.closeModal = function() {
            document.getElementById('apply-modal').classList.add('hidden');
        }

        // 3. –û–¢–ü–†–ê–í–ò–¢–¨ –î–ê–ù–ù–´–ï (–†–µ–∞–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫)
        window.submitApplication = async function() {
            const price = document.getElementById('input-price').value;
            const message = document.getElementById('input-message').value;

            if (!price) {
                tg.showAlert("–£–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É!");
                return;
            }

            closeModal(); // –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
            
            // –ê–Ω–∏–º–∞—Ü–∏—è —É–ª–µ—Ç–∞–Ω–∏—è –≤–ø—Ä–∞–≤–æ
            const card = document.getElementById('active-card');
            if (card) {
                card.style.transform = "translateX(120%) rotate(20deg)";
                card.style.opacity = "0";
            }

            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –∫–∞—Å—Ç–æ–º–Ω–æ–π —Ü–µ–Ω–æ–π –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ–º
                // encodeURIComponent –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã —Ä—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç –Ω–µ —Å–ª–æ–º–∞–ª —Å—Å—ã–ª–∫—É
                const url = `/api/worker/apply/${currentOrder.id}?price=${price}&message=${encodeURIComponent(message)}`;
                
                await fetch(url, {
                    method: 'POST',
                    headers: { 'Authorization': tg.initData }
                });

                tg.showAlert("–û—Ç–∫–ª–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");

                // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
                setTimeout(() => {
                    if (card) card.remove();
                    ordersQueue.shift();
                    renderNextCard();
                }, 300);

            } catch (e) {
                tg.showAlert("–û—à–∏–±–∫–∞: " + e.message);
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                renderNextCard(); 
            }
        }

        // ... (–§—É–Ω–∫—Ü–∏–∏ loadFeed, renderNextCard, handleSkip –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –±—ã–ª–∏) ...

        async function loadFeed() {
            try {
                const response = await fetch('/api/worker/feed?v=' + Date.now(), {
                    headers: { 'Authorization': tg.initData }
                });
                const data = await response.json();
                document.getElementById('loading').remove();
                if (data.length === 0) { showEmptyState(); return; }
                ordersQueue = data;
                renderNextCard();
            } catch (e) { tg.showAlert("–û—à–∏–±–∫–∞: " + e.message); }
        }

        function renderNextCard() {
            if (ordersQueue.length === 0) { showEmptyState(); return; }
            currentOrder = ordersQueue[0];
            const stack = document.getElementById('card-stack');
            
            let imageHtml = `<div class="h-48 bg-gray-100 flex items-center justify-center text-4xl">üó∫</div>`;
            if (currentOrder.photos && currentOrder.photos.length > 0) {
                 imageHtml = `<div class="h-48 bg-gray-200 bg-cover bg-center" style="background-image: url('/api/upload/file/${currentOrder.photos[0]}')"></div>`;
            }

            const card = document.createElement('div');
            card.id = 'active-card';
            card.className = "absolute inset-0 bg-white dark:bg-gray-800 rounded-3xl shadow-xl border border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden transition-all duration-300";
            card.innerHTML = `
                ${imageHtml}
                <div class="p-6 flex-1 flex flex-col">
                    <div class="flex justify-between items-start">
                        <h2 class="text-2xl font-bold text-tg_text">${currentOrder.service_type}</h2>
                        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-lg font-bold">${currentOrder.price} ‚ÇΩ</span>
                    </div>
                    <p class="text-gray-400 text-sm mt-1">${currentOrder.address}</p>
                    <div class="mt-4 flex-1 overflow-y-auto">
                        <p class="text-tg_text text-lg leading-relaxed">${currentOrder.comment || "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è."}</p>
                        <div class="mt-4 flex gap-2 flex-wrap">
                            <span class="px-3 py-1 bg-gray-100 rounded text-sm text-gray-600">üïí ${currentOrder.duration}—á</span>
                        </div>
                    </div>
                </div>`;
            stack.appendChild(card);
        }

        function showEmptyState() {
            document.getElementById('no-orders').classList.remove('hidden');
            document.getElementById('no-orders').classList.add('flex');
        }

        window.handleSkip = async function() {
            if (!currentOrder) return;
            const card = document.getElementById('active-card');
            card.style.transform = "translateX(-120%) rotate(-20deg)";
            card.style.opacity = "0";
            fetch(`/api/worker/skip/${currentOrder.id}`, { method: 'POST', headers: { 'Authorization': tg.initData } });
            setTimeout(() => { card.remove(); ordersQueue.shift(); renderNextCard(); }, 300);
        }
        
        loadFeed();
    });
</script>
{% endblock %}