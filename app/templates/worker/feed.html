{% extends "base.html" %}

{% block title %}–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤{% endblock %}

{% block content %}
<div class="flex flex-col h-screen overflow-hidden bg-gray-50 dark:bg-gray-900">
    
    <div class="px-4 py-3 flex justify-between items-center z-10">
        <h1 class="text-xl font-bold text-tg_text">–õ–µ–Ω—Ç–∞ –∑–∞–∫–∞–∑–æ–≤</h1>
        <div class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-bold">
            –í–∞—à–∞ —Ä–æ–ª—å: –ú–∞—Å—Ç–µ—Ä
        </div>
    </div>

    <div id="card-stack" class="flex-1 relative mx-4 mb-24 mt-2">
        
        <div id="no-orders" class="hidden absolute inset-0 flex flex-col items-center justify-center text-center">
            <div class="text-6xl mb-4">üéâ</div>
            <h3 class="text-xl font-bold text-tg_text">–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h3>
            <p class="text-gray-500 mt-2 px-6">–í—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–ª–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã –≤ –≤–∞—à–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏. –ó–∞–≥–ª—è–Ω–∏—Ç–µ –ø–æ–∑–∂–µ.</p>
            <button onclick="location.reload()" class="mt-6 px-6 py-2 bg-blue-500 text-white rounded-xl">
                –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>

        <div id="loading" class="absolute inset-0 bg-white dark:bg-gray-800 rounded-3xl shadow-lg border border-gray-200 dark:border-gray-700 p-6 animate-pulse">
            <div class="h-64 bg-gray-200 dark:bg-gray-700 rounded-xl mb-4"></div>
            <div class="h-8 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-2"></div>
            <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-1/2"></div>
        </div>
    </div>

    <div class="fixed bottom-6 left-0 right-0 px-8 flex justify-center space-x-6 z-20">
        <button onclick="handleSkip()" class="w-16 h-16 rounded-full bg-white dark:bg-gray-800 shadow-xl border border-red-100 text-red-500 flex items-center justify-center text-3xl hover:scale-110 transition-transform active:scale-95">
            ‚ùå
        </button>
        
        <button onclick="handleApply()" class="w-16 h-16 rounded-full bg-blue-500 shadow-xl shadow-blue-500/30 text-white flex items-center justify-center text-3xl hover:scale-110 transition-transform active:scale-95">
            ‚úÖ
        </button>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {

    const tg = window.Telegram.WebApp;
    tg.expand();
    
    let ordersQueue = [];
    let currentOrder = null;

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–µ–Ω—Ç—ã
    async function loadFeed() {
        try {
            const response = await fetch('/api/worker/feed?v=' + Date.now(), {
                headers: { 'Authorization': tg.initData }
            });
            const data = await response.json();
            
            document.getElementById('loading').remove(); // –£–±–∏—Ä–∞–µ–º —Å–∫–µ–ª–µ—Ç–æ–Ω
            
            if (data.length === 0) {
                showEmptyState();
                return;
            }
            
            ordersQueue = data;
            renderNextCard();
            
        } catch (e) {
            tg.showAlert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + e.message);
        }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–∫–∞–∑
    function renderNextCard() {
        if (ordersQueue.length === 0) {
            showEmptyState();
            return;
        }

        currentOrder = ordersQueue[0]; // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π
        const stack = document.getElementById('card-stack');
        
        // –°–æ–∑–¥–∞–µ–º HTML –∫–∞—Ä—Ç–æ—á–∫–∏
        const card = document.createElement('div');
        card.id = 'active-card';
        card.className = "absolute inset-0 bg-white dark:bg-gray-800 rounded-3xl shadow-xl border border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden transition-all duration-300";
        
        // –ö–∞—Ä—Ç–∞ (–∑–∞–≥–ª—É—à–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–æ–π) –∏–ª–∏ —Ñ–æ—Ç–æ
        let imageHtml = `<div class="h-48 bg-gray-100 flex items-center justify-center text-4xl">üó∫</div>`;
        if (currentOrder.photos && currentOrder.photos.length > 0) {
             // –¢—É—Ç –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ
             imageHtml = `<div class="h-48 bg-gray-200 bg-cover bg-center" style="background-image: url('/api/upload/file/${currentOrder.photos[0]}')"></div>`;
        }

        card.innerHTML = `
            ${imageHtml}
            <div class="p-6 flex-1 flex flex-col">
                <div class="flex justify-between items-start">
                    <h2 class="text-2xl font-bold text-tg_text">${currentOrder.service_type}</h2>
                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-lg font-bold">${currentOrder.price} ‚ÇΩ</span>
                </div>
                
                <p class="text-gray-400 text-sm mt-1">${currentOrder.address}</p>
                
                <div class="mt-4 flex-1 overflow-y-auto">
                    <p class="text-tg_text text-lg leading-relaxed">
                        ${currentOrder.comment || "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è. –ù—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–∞–±–æ—Ç—É –∞–∫–∫—É—Ä–∞—Ç–Ω–æ."}
                    </p>
                    <div class="mt-4 flex gap-2 flex-wrap">
                        <span class="px-3 py-1 bg-gray-100 rounded text-sm text-gray-600">üïí ${currentOrder.duration}—á</span>
                        <span class="px-3 py-1 bg-gray-100 rounded text-sm text-gray-600">üìç 2.5 –∫–º</span>
                    </div>
                </div>
            </div>
        `;
        
        stack.appendChild(card);
    }

    function showEmptyState() {
        document.getElementById('no-orders').classList.remove('hidden');
        document.getElementById('no-orders').classList.add('flex');
    }

    // --- –õ–û–ì–ò–ö–ê –î–ï–ô–°–¢–í–ò–ô ---

    window.handleSkip = async function()  {
        if (!currentOrder) return;
        
        // –ê–Ω–∏–º–∞—Ü–∏—è —É–ª–µ—Ç–∞–Ω–∏—è –≤–ª–µ–≤–æ
        const card = document.getElementById('active-card');
        card.style.transform = "translateX(-120%) rotate(-20deg)";
        card.style.opacity = "0";
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ (—Ñ–æ–Ω–æ–º)
        fetch(`/api/worker/skip/${currentOrder.id}`, {
            method: 'POST',
            headers: { 'Authorization': tg.initData }
        });

        // –£–¥–∞–ª—è–µ–º –∏–∑ –æ—á–µ—Ä–µ–¥–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é
        setTimeout(() => {
            card.remove();
            ordersQueue.shift();
            renderNextCard();
        }, 300);
    }

    window.handleApply = async function() {
        if (!currentOrder) return;
        
        // –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (–∏–ª–∏ –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å)
        tg.showConfirm(`–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è –Ω–∞ –∑–∞–∫–∞–∑ –∑–∞ ${currentOrder.price} ‚ÇΩ?`, async (ok) => {
            if (!ok) return;

            // –ê–Ω–∏–º–∞—Ü–∏—è —É–ª–µ—Ç–∞–Ω–∏—è –≤–ø—Ä–∞–≤–æ
            const card = document.getElementById('active-card');
            card.style.transform = "translateX(120%) rotate(20deg)";
            card.style.opacity = "0";

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–∫–ª–∏–∫–∞
            // –ü–æ–∫–∞ —à–ª–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø–æ–∑–∂–µ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å input
            await fetch(`/api/worker/apply/${currentOrder.id}?price=${currentOrder.price}&message=–ì–æ—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω–∏—Ç—å`, {
                method: 'POST',
                headers: { 'Authorization': tg.initData }
            });

            setTimeout(() => {
                card.remove();
                ordersQueue.shift();
                renderNextCard();
                tg.showAlert("–û—Ç–∫–ª–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.");
            }, 300);
        });
    }
    loadFeed();
    });
</script>
{% endblock %}