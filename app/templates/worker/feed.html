{% extends "base.html" %}

{% block title %}–õ–µ–Ω—Ç–∞ –∑–∞–∫–∞–∑–æ–≤{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<div class="flex flex-col h-screen overflow-hidden bg-gray-50 dark:bg-gray-900 relative">
    
    <div class="px-4 py-3 flex justify-between items-center z-10">
        <h1 class="text-xl font-bold text-tg_text">–õ–µ–Ω—Ç–∞ –∑–∞–∫–∞–∑–æ–≤</h1>
        <div id="gps-status" class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-bold">
            üì° –ü–æ–∏—Å–∫ GPS...
        </div>
    </div>

    <div id="card-stack" class="flex-1 relative mx-4 mb-24 mt-2">
        <div id="no-orders" class="hidden absolute inset-0 flex flex-col items-center justify-center text-center">
            <div class="text-6xl mb-4">üéâ</div>
            <h3 class="text-xl font-bold text-tg_text">–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h3>
            <button onclick="location.reload()" class="mt-6 px-6 py-2 bg-blue-500 text-white rounded-xl">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div id="loading" class="absolute inset-0 bg-white dark:bg-gray-800 rounded-3xl shadow-lg p-6 animate-pulse">
            <div class="h-64 bg-gray-200 rounded-xl mb-4"></div>
        </div>
    </div>

    <div class="fixed bottom-6 left-0 right-0 px-8 flex justify-center space-x-6 z-20">
        <button onclick="handleSkip()" class="w-16 h-16 rounded-full bg-white dark:bg-gray-800 shadow-xl border border-red-100 text-red-500 text-3xl">‚ùå</button>
        <button onclick="openApplyModal()" class="w-16 h-16 rounded-full bg-blue-500 shadow-xl shadow-blue-500/30 text-white text-3xl">‚úÖ</button>
    </div>

    <div id="apply-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 w-full max-w-md p-6 rounded-2xl shadow-2xl m-4">
            <h3 class="text-xl font-bold text-tg_text mb-4">–í–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</h3>
            <input id="input-price" type="number" class="w-full p-3 mb-4 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl text-lg font-bold text-tg_text" placeholder="–¶–µ–Ω–∞">
            <textarea id="input-message" rows="3" class="w-full p-3 mb-6 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl text-tg_text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
            <div class="flex space-x-3">
                <button onclick="closeModal()" class="flex-1 py-3 bg-gray-100 dark:bg-gray-700 text-tg_text rounded-xl">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="submitApplication()" class="flex-1 py-3 bg-blue-500 text-white rounded-xl font-bold">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        let ordersQueue = [];
        let currentOrder = null;
        let workerLocation = null; // {lat, lng}

        // 1. –ü–û–õ–£–ß–ê–ï–ú GPS –†–ê–ë–û–¢–ù–ò–ö–ê
        function initGPS() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        workerLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        document.getElementById('gps-status').className = "px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-bold";
                        document.getElementById('gps-status').innerText = "üìç GPS –Ω–∞–π–¥–µ–Ω";
                        // –ï—Å–ª–∏ –∑–∞–∫–∞–∑—ã —É–∂–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å, –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                        if (currentOrder) updateDistanceInfo(); 
                    },
                    (error) => {
                        document.getElementById('gps-status').innerText = "‚ùå –ù–µ—Ç GPS";
                        tg.showAlert("–í–∫–ª—é—á–∏—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ!");
                    }
                );
            }
        }

        // 2. –†–ê–°–ß–ï–¢ –†–ê–°–°–¢–û–Ø–ù–ò–Ø (–§–æ—Ä–º—É–ª–∞ Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –∫–º
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return (R * c).toFixed(1); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–º —Å 1 –∑–Ω–∞–∫–æ–º (2.5)
        }

        async function loadFeed() {
            try {
                const response = await fetch('/api/worker/feed?v=' + Date.now(), {
                    headers: { 'Authorization': tg.initData }
                });
                const data = await response.json();
                document.getElementById('loading').remove();
                if (data.length === 0) { showEmptyState(); return; }
                ordersQueue = data;
                renderNextCard();
            } catch (e) { console.error(e); }
        }

        function renderNextCard() {
            if (ordersQueue.length === 0) { showEmptyState(); return; }
            currentOrder = ordersQueue[0];
            const stack = document.getElementById('card-stack');
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∫–∞—Ä—Ç—ã
            const mapId = `map-${currentOrder.id}`;

            const card = document.createElement('div');
            card.id = 'active-card';
            card.className = "absolute inset-0 bg-white dark:bg-gray-800 rounded-3xl shadow-xl border border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden transition-all duration-300";
            
            // –í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å: –ö–ê–†–¢–ê
            // –ú—ã —Å–æ–∑–¥–∞–µ–º div –¥–ª—è –∫–∞—Ä—Ç—ã –≤–º–µ—Å—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∏
            card.innerHTML = `
                <div id="${mapId}" class="h-56 bg-gray-100 z-0"></div>
                
                <div class="p-6 flex-1 flex flex-col z-10 bg-white dark:bg-gray-800 rounded-t-3xl -mt-6">
                    <div class="flex justify-between items-start">
                        <h2 class="text-2xl font-bold text-tg_text">${currentOrder.service_type}</h2>
                        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-lg font-bold">${currentOrder.price} ‚ÇΩ</span>
                    </div>
                    
                    <p class="text-gray-400 text-sm mt-1 truncate">${currentOrder.address}</p>
                    
                    <div class="mt-4 flex-1 overflow-y-auto">
                        <p class="text-tg_text text-lg leading-relaxed">${currentOrder.comment || "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è."}</p>
                        
                        <div class="mt-4 flex gap-2 flex-wrap">
                            <span class="px-3 py-1 bg-gray-100 rounded text-sm text-gray-600">üïí ${currentOrder.duration}—á</span>
                            <span id="dist-${currentOrder.id}" class="px-3 py-1 bg-blue-50 text-blue-600 rounded text-sm font-bold">
                                üîÑ –†–∞—Å—á–µ—Ç...
                            </span>
                        </div>

                     <a href="dgis://2gis.ru/routeSearch/to/${currentOrder.lon},${currentOrder.lat}/go" 
   class="mt-4 block w-full py-2 bg-gray-100 text-center rounded-lg text-sm text-green-600 font-medium hover:bg-green-50 transition-colors">
   üå≤ –û—Ç–∫—Ä—ã—Ç—å –≤ 2GIS
</a>
                    </div>
                </div>`;
            
            stack.appendChild(card);

            // 3. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–£–ï–ú –ö–ê–†–¢–£ (–ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ DOM)
            initCardMap(mapId, currentOrder.lat, currentOrder.lon);
            updateDistanceInfo();
        }

        // –†–∏—Å—É–µ–º –∫–∞—Ä—Ç—É –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏
        function initCardMap(elementId, orderLat, orderLon) {
            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –∑–∞–∫–∞–∑–µ
            const map = L.map(elementId, {
                zoomControl: false, // –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∑—É–º–∞, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∏
                attributionControl: false
            }).setView([orderLat, orderLon], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            // –ú–∞—Ä–∫–µ—Ä –∑–∞–∫–∞–∑–∞ (–ö—Ä–∞—Å–Ω—ã–π)
            const orderIcon = L.divIcon({className: 'text-4xl', html: 'üìç', iconSize: [40, 40], iconAnchor: [20, 40]});
            L.marker([orderLat, orderLon], {icon: orderIcon}).addTo(map);

            // –ï—Å–ª–∏ –µ—Å—Ç—å GPS —Ä–∞–±–æ—Ç–Ω–∏–∫–∞ - —Ä–∏—Å—É–µ–º –ª–∏–Ω–∏—é –∏ –≤—Ç–æ—Ä–æ–≥–æ —á–µ–ª–æ–≤–µ—á–∫–∞
            if (workerLocation) {
                const workerIcon = L.divIcon({className: 'text-2xl', html: 'üõµ', iconSize: [30, 30], iconAnchor: [15, 15]});
                L.marker([workerLocation.lat, workerLocation.lng], {icon: workerIcon}).addTo(map);

                // –†–∏—Å—É–µ–º –ø—É–Ω–∫—Ç–∏—Ä–Ω—É—é –ª–∏–Ω–∏—é
                const latlngs = [
                    [workerLocation.lat, workerLocation.lng],
                    [orderLat, orderLon]
                ];
                const polyline = L.polyline(latlngs, {color: 'blue', dashArray: '5, 10', weight: 3}).addTo(map);
                
                // –ó—É–º–º–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –≤–ª–µ–∑–ª–∏ –æ–±–µ —Ç–æ—á–∫–∏
                map.fitBounds(polyline.getBounds(), {padding: [20, 20]});
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
        function updateDistanceInfo() {
            if (!currentOrder || !workerLocation) return;
            
            const dist = calculateDistance(workerLocation.lat, workerLocation.lng, currentOrder.lat, currentOrder.lon);
            const badge = document.getElementById(`dist-${currentOrder.id}`);
            if (badge) {
                badge.innerText = `üìè ${dist} –∫–º –æ—Ç –≤–∞—Å`;
            }
        }

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (handleSkip, openApplyModal, closeModal, submitApplication) –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –±—ã–ª–∏...
        window.handleSkip = async function() {
            if (!currentOrder) return;
            const card = document.getElementById('active-card');
            card.style.transform = "translateX(-120%) rotate(-20deg)";
            card.style.opacity = "0";
            fetch(`/api/worker/skip/${currentOrder.id}`, { method: 'POST', headers: { 'Authorization': tg.initData } });
            setTimeout(() => { card.remove(); ordersQueue.shift(); renderNextCard(); }, 300);
        }

        window.openApplyModal = function() {
            if (!currentOrder) return;
            document.getElementById('input-price').value = currentOrder.price;
            document.getElementById('apply-modal').classList.remove('hidden');
        }

        window.closeModal = function() { document.getElementById('apply-modal').classList.add('hidden'); }

        window.submitApplication = async function() {
            const price = document.getElementById('input-price').value;
            const msg = document.getElementById('input-message').value;
            closeModal();
            const card = document.getElementById('active-card');
            if (card) { card.style.transform = "translateX(120%) rotate(20deg)"; card.style.opacity = "0"; }
            
            await fetch(`/api/worker/apply/${currentOrder.id}?price=${price}&message=${encodeURIComponent(msg)}`, {
                method: 'POST', headers: { 'Authorization': tg.initData }
            });
            tg.showAlert("–û—Ç–∫–ª–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
            setTimeout(() => { if (card) card.remove(); ordersQueue.shift(); renderNextCard(); }, 300);
        }

        function showEmptyState() {
            document.getElementById('no-orders').classList.remove('hidden');
            document.getElementById('no-orders').classList.add('flex');
        }

        // –ó–∞–ø—É—Å–∫
        initGPS();
        loadFeed();
    });
</script>
{% endblock %}