{% extends "base.html" %}

{% block title %}–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å{% endblock %}

{% block content %}
<div class="relative w-full h-[calc(100vh-20px)] rounded-xl overflow-hidden shadow-lg">
    
    <div class="absolute top-4 left-4 right-4 z-[500]">
        <div class="bg-white dark:bg-gray-800 p-2 rounded-xl shadow-md flex items-center">
            <span class="text-gray-400 pl-2">üìç</span>
            <input type="text" id="address-input" 
                   placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –ø–æ—Å—Ç–∞–≤—å—Ç–µ —Ç–æ—á–∫—É..." 
                   class="w-full bg-transparent border-none focus:ring-0 text-sm text-tg_text placeholder-gray-400 ml-2">
        </div>
    </div>

    <div id="map" class="w-full h-full z-0"></div>

    <div id="summary-card" class="absolute bottom-0 left-0 right-0 z-[500] bg-white dark:bg-gray-900 rounded-t-2xl shadow-[0_-5px_15px_rgba(0,0,0,0.1)] transform translate-y-full transition-transform duration-300 p-5">
        <h3 class="font-bold text-lg mb-3 text-tg_text">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ</h3>
        
        <div class="space-y-2 text-sm text-gray-600 dark:text-gray-300 mb-4">
            <div class="flex justify-between">
                <span>–£—Å–ª—É–≥–∞:</span>
                <span class="font-medium text-tg_text">{{ order_data.service_name }}</span>
            </div>
            <div class="flex justify-between">
                <span>–í—Ä–µ–º—è:</span>
                <span class="font-medium text-tg_text">{{ order_data.duration }} —á.</span>
            </div>
            <div class="flex justify-between">
                <span>–ë—é–¥–∂–µ—Ç:</span>
                <span class="font-medium text-green-600">{{ order_data.price }} ‚ÇΩ</span>
            </div>
            <div class="pt-2 border-t border-gray-100 dark:border-gray-700">
                <span class="block text-xs text-gray-400">–ê–¥—Ä–µ—Å:</span>
                <span id="final-address" class="font-medium text-tg_text">...</span>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}


{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.BackButton.show();
    tg.BackButton.onClick(() => history.back());

    // –î–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ (–∏–∑ Python —Å–ª–æ–≤–∞—Ä—è –≤ JS –æ–±—ä–µ–∫—Ç)
    const initialOrderData = {{ order_data | tojson }};
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    let currentMarker = null;
    let selectedCoords = null;
    let selectedAddress = "";

    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã (—Ü–µ–Ω—Ç—Ä - –ú–æ—Å–∫–≤–∞ –∏–ª–∏ –ë–∏—à–∫–µ–∫, –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å)
    // –ü–æ —Ö–æ—Ä–æ—à–µ–º—É –Ω–∞–¥–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é —é–∑–µ—Ä–∞, –Ω–æ –ø–æ–∫–∞ –≤–æ–∑—å–º–µ–º –¥–µ—Ñ–æ–ª—Ç
    const map = L.map('map').setView([55.7558, 37.6173], 13);

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π –∫–∞—Ä—Ç—ã (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OSM'
    }).addTo(map);

    // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –ª–æ–∫–∞—Ü–∏—é —é–∑–µ—Ä–∞
    map.locate({setView: true, maxZoom: 16});
    
    // –°–æ–±—ã—Ç–∏–µ: –õ–æ–∫–∞—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞
    map.on('locationfound', function(e) {
        setPin(e.latlng); // –°—Ç–∞–≤–∏–º –ø–∏–Ω —Ç—É–¥–∞, –≥–¥–µ —é–∑–µ—Ä
    });


    // 2. –õ–æ–≥–∏–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
    map.on('click', function(e) {
        setPin(e.latlng);
    });

    // –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±—É–ª–∞–≤–∫–∏
    function setPin(latlng) {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä
        if (currentMarker) map.removeLayer(currentMarker);
        
        // –°—Ç–∞–≤–∏–º –Ω–æ–≤—ã–π
        currentMarker = L.marker(latlng).addTo(map);
        selectedCoords = latlng;
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –∫ —Ç–æ—á–∫–µ
        map.panTo(latlng);

        // "–ú–∞–≥–∏—è": –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º (Nominatim API)
        fetchAddress(latlng.lat, latlng.lng);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∞–¥—Ä–µ—Å"
        tg.MainButton.setText("–í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å");
        tg.MainButton.show();
        
        // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–∫–∞ —Å–≤–æ–¥–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –æ—Ç–∫—Ä—ã—Ç–∞
        hideSummary();
    }

    // 3. –û–±—Ä–∞—Ç–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ (–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã -> –¢–µ–∫—Å—Ç)
    async function fetchAddress(lat, lng) {
        const input = document.getElementById('address-input');
        input.value = "–ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥—Ä–µ—Å–∞...";
        
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
            const data = await response.json();
            
            // –ë–µ—Ä–µ–º —É–ª–∏—Ü—É –∏ –Ω–æ–º–µ—Ä –¥–æ–º–∞, –∏–ª–∏ display_name —Ü–µ–ª–∏–∫–æ–º
            const addr = data.address;
            const shortAddr = (addr.road ? addr.road : '') + (addr.house_number ? ', ' + addr.house_number : '');
            
            selectedAddress = shortAddr || data.display_name;
            input.value = selectedAddress;
        } catch (e) {
            input.value = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–¥—Ä–µ—Å";
            selectedAddress = "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: " + lat.toFixed(4) + ", " + lng.toFixed(4);
        }
    }
    
    // 4. –õ–æ–≥–∏–∫–∞ –ì–ª–∞–≤–Ω–æ–π –ö–Ω–æ–ø–∫–∏
    tg.MainButton.onClick(() => {
        const summaryCard = document.getElementById('summary-card');
        
        // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –≥–æ–≤–æ—Ä–∏—Ç "–í—ã–±—Ä–∞—Ç—å –∞–¥—Ä–µ—Å" -> –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥
        if (tg.MainButton.text === "–í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å") {
            showSummary();
        } 
        // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –≥–æ–≤–æ—Ä–∏—Ç "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑" -> –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        else if (tg.MainButton.text === "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑") {
            sendOrder();
        }
    });

    function showSummary() {
        document.getElementById('final-address').innerText = selectedAddress;
        document.getElementById('summary-card').classList.remove('translate-y-full'); // –í—ã–µ–∑–∂–∞–µ—Ç —Å–Ω–∏–∑—É
        tg.MainButton.setText("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑");
        tg.MainButton.color = "#34d399"; // –ó–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
    }

    function hideSummary() {
        document.getElementById('summary-card').classList.add('translate-y-full');
        tg.MainButton.setText("–í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å");
        tg.MainButton.color = tg.themeParams.button_color; // –í–µ—Ä–Ω—É—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ü–≤–µ—Ç
    }
    
    // 5. –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –±—ç–∫–µ–Ω–¥
    async function sendOrder() {
        tg.MainButton.showProgress(); // –ö—Ä—É—Ç–∏–ª–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
        
        const payload = {
            ...initialOrderData, // id —É—Å–ª—É–≥–∏, –≤—Ä–µ–º—è, —Ü–µ–Ω–∞...
            address: selectedAddress,
            latitude: selectedCoords.lat,
            longitude: selectedCoords.lng
        };

        try {
            const response = await fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                tg.MainButton.hideProgress();
                tg.close(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp
                // –ò–ª–∏ –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å alert("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω!");
            } else {
                alert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞!");
                tg.MainButton.hideProgress();
            }
        } catch (e) {
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + e);
            tg.MainButton.hideProgress();
        }
    }

    // –°–ª—É—à–∞–µ–º —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –∞–¥—Ä–µ—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –º–æ–∂–Ω–æ –ø—Ä–∏–∫—Ä—É—Ç–∏—Ç—å –ø–æ–∏—Å–∫)
    document.getElementById('address-input').addEventListener('input', (e) => {
        selectedAddress = e.target.value;
    });

</script>
{% endblock %}