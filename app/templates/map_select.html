{% extends "base.html" %}

{% block title %}–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å{% endblock %}

{% block content %}
<div class="relative w-full h-[calc(100vh-20px)] rounded-xl overflow-hidden shadow-lg">
    
    <div class="absolute top-4 left-4 right-4 z-[1000]"> <div class="relative"> <div class="bg-white dark:bg-gray-800 p-2 rounded-xl shadow-md flex items-center">
                <span class="text-gray-400 pl-2">üìç</span>
                <input type="text" id="address-input" 
                       autocomplete="off"
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞..." 
                       class="w-full bg-transparent border-none focus:ring-0 text-sm text-tg_text placeholder-gray-400 ml-2">
                <button id="clear-input" class="hidden text-gray-400 px-2">‚úï</button>
            </div>

            <ul id="suggestions-list" class="hidden absolute top-full left-0 right-0 mt-2 bg-white dark:bg-gray-800 rounded-xl shadow-lg max-h-60 overflow-y-auto z-[1001] divide-y divide-gray-100 dark:divide-gray-700">
                </ul>
        </div>
    </div>

    <div id="map" class="w-full h-full z-0"></div>

    <div id="summary-card" class="absolute bottom-0 left-0 right-0 z-[500] bg-white dark:bg-gray-900 rounded-t-2xl shadow-[0_-5px_15px_rgba(0,0,0,0.1)] transform translate-y-full transition-transform duration-300 p-5">
        <h3 class="font-bold text-lg mb-3 text-tg_text">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ</h3>
        
        <div class="space-y-2 text-sm text-gray-600 dark:text-gray-300 mb-4">
            <div class="flex justify-between">
                <span>–£—Å–ª—É–≥–∞:</span>
                <span class="font-medium text-tg_text">{{ order_data.service_name }}</span>
            </div>
            <div class="flex justify-between">
                <span>–í—Ä–µ–º—è:</span>
                <span class="font-medium text-tg_text">{{ order_data.duration }} —á.</span>
            </div>
            <div class="flex justify-between">
                <span>–ë—é–¥–∂–µ—Ç:</span>
                <span class="font-medium text-green-600">{{ order_data.price }} ‚ÇΩ</span>
            </div>
            <div class="pt-2 border-t border-gray-100 dark:border-gray-700">
                <span class="block text-xs text-gray-400">–ê–¥—Ä–µ—Å:</span>
                <span id="final-address" class="font-medium text-tg_text">...</span>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª */
    #suggestions-list::-webkit-scrollbar {
        width: 4px;
    }
    #suggestions-list::-webkit-scrollbar-thumb {
        background-color: #ccc;
        border-radius: 4px;
    }
</style>
{% endblock %}


{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.BackButton.show();
        tg.BackButton.onClick(() => history.back());

        const initialOrderData = {{ order_data | tojson }};
    
        let currentMarker = null;
        let selectedCoords = null;
        let selectedAddress = "";
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è-—Ñ–ª–∞–≥, —á—Ç–æ–±—ã –æ—Ç–ª–∏—á–∞—Ç—å —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –æ—Ç –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
        let isTyping = false; 

        // === 1. –ö–ê–†–¢–ê ===
        const map = L.map('map').setView([55.7558, 37.6173], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OSM',
            maxZoom: 19
        }).addTo(map);

        setTimeout(() => { map.invalidateSize(); }, 100);

        map.locate({setView: true, maxZoom: 16});
        
        map.on('locationfound', function(e) {
            setPin(e.latlng, true); // true = –ø–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å —Ç–µ–∫—Å—Ç–æ–º
        });
        
        map.on('click', function(e) {
            setPin(e.latlng, true);
        });

        // === 2. –§–£–ù–ö–¶–ò–ò –ö–ê–†–¢–´ ===

        function setPin(latlng, shouldFetchAddress = true) {
            if (currentMarker) map.removeLayer(currentMarker);
            
            currentMarker = L.marker(latlng).addTo(map);
            selectedCoords = latlng;
            
            map.panTo(latlng);

            // –ï—Å–ª–∏ –º—ã –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ –∫–∞—Ä—Ç–µ, —Ç–æ –∏—â–µ–º –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
            // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ –∏–∑ –ø–æ–∏—Å–∫–∞, —Ç–æ –∞–¥—Ä–µ—Å —É–∂–µ –µ—Å—Ç—å, –∏—Å–∫–∞—Ç—å –Ω–µ –Ω–∞–¥–æ
            if (shouldFetchAddress) {
                fetchAddressReverse(latlng.lat, latlng.lng);
            }
            
            tg.MainButton.setText("–í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å");
            tg.MainButton.show();
            hideSummary();
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
            document.getElementById('suggestions-list').classList.add('hidden');
        }

        // –û–±—Ä–∞—Ç–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ (–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã -> –ê–¥—Ä–µ—Å)
        async function fetchAddressReverse(lat, lng) {
            const input = document.getElementById('address-input');
            // –ù–µ –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –ø–µ—á–∞—Ç–∞–µ—Ç
            if (!isTyping) {
                input.value = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            }
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ru`);
                if (!response.ok) throw new Error('Error');
                const data = await response.json();
                
                selectedAddress = formatAddress(data);
                
                if (!isTyping) {
                    input.value = selectedAddress;
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–µ—Å—Ç–∏–∫
                    document.getElementById('clear-input').classList.remove('hidden');
                }

            } catch (e) {
                console.error(e);
                if (!isTyping) input.value = "–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω";
            }
        }

        // === 3. –ü–û–ò–°–ö (–ê–í–¢–û–ö–û–ú–ü–õ–ò–¢) ===
        
        const searchInput = document.getElementById('address-input');
        const suggestionsList = document.getElementById('suggestions-list');
        const clearBtn = document.getElementById('clear-input');

        // –§—É–Ω–∫—Ü–∏—è "Debounce" - —á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –∫–∞–∂–¥—É—é –±—É–∫–≤—É
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞
        searchInput.addEventListener('input', debounce(async (e) => {
            const query = e.target.value.trim();
            isTyping = true; // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∞–µ—Ç

            if (query.length > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
                suggestionsList.classList.add('hidden');
                return;
            }

            if (query.length < 3) return; // –ò—â–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–æ–ª—å—à–µ 2 –±—É–∫–≤

            try {
                // –ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞ (Search API)
                // viewbox - –º–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –ø–æ–∏—Å–∫ –æ–±–ª–∞—Å—Ç—å—é –∫–∞—Ä—Ç—ã, –Ω–æ –ø–æ–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&accept-language=ru&limit=5`);
                const results = await response.json();

                renderSuggestions(results);
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞", e);
            }
        }, 500)); // –ó–∞–¥–µ—Ä–∂–∫–∞ 500–º—Å

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞
        function renderSuggestions(results) {
            suggestionsList.innerHTML = '';
            
            if (results.length === 0) {
                suggestionsList.classList.add('hidden');
                return;
            }

            results.forEach(item => {
                const li = document.createElement('li');
                li.className = "px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer text-sm text-tg_text border-b last:border-0 border-gray-100 dark:border-gray-700";
                li.innerText = item.display_name; // –ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å
                
                li.onclick = () => {
                    // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –ø–æ–¥—Å–∫–∞–∑–∫—É:
                    isTyping = false; // –ü–µ—Ä–µ—Å—Ç–∞–ª–∏ –ø–µ—á–∞—Ç–∞—Ç—å
                    searchInput.value = item.display_name;
                    selectedAddress = item.display_name;
                    
                    // –°—Ç–∞–≤–∏–º —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ
                    const lat = parseFloat(item.lat);
                    const lon = parseFloat(item.lon);
                    const latlng = L.latLng(lat, lon);
                    
                    // setPin —Å false, —Ç.–∫. –∞–¥—Ä–µ—Å —É –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å, –Ω–µ –Ω–∞–¥–æ –µ–≥–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å
                    setPin(latlng, false); 
                    
                    suggestionsList.classList.add('hidden');
                };
                
                suggestionsList.appendChild(li);
            });

            suggestionsList.classList.remove('hidden');
        }

        // –û—á–∏—Å—Ç–∫–∞ –≤–≤–æ–¥–∞
        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            suggestionsList.classList.add('hidden');
            clearBtn.classList.add('hidden');
            isTyping = true;
        });

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ (—É–ø—Ä–æ—Å—Ç–∏–ª –∏ –≤—ã–Ω–µ—Å –æ—Ç–¥–µ–ª—å–Ω–æ)
        function formatAddress(data) {
            let shortAddr = data.display_name;
            if (data.address) {
                const road = data.address.road || data.address.street || "";
                const number = data.address.house_number || "";
                if (road) {
                    shortAddr = `${road}${number ? ', ' + number : ''}`;
                    // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä–æ–¥ –µ—Å–ª–∏ –µ—Å—Ç—å
                    const city = data.address.city || data.address.town || data.address.village || "";
                    if(city) shortAddr += `, ${city}`;
                }
            }
            return shortAddr;
        }

        // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !suggestionsList.contains(e.target)) {
                suggestionsList.classList.add('hidden');
                isTyping = false;
            }
        });

        // === 4. TELEGRAM UI ===

        tg.MainButton.onClick(() => {
            if (tg.MainButton.text === "–í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å") {
                showSummary();
            } 
            else if (tg.MainButton.text === "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑") {
                sendOrder();
            }
        });

        function showSummary() {
            const summary = document.getElementById('summary-card');
            const addrText = document.getElementById('final-address');
            
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª –∞–¥—Ä–µ—Å —Ä—É–∫–∞–º–∏, –Ω–æ –Ω–µ –≤—ã–±—Ä–∞–ª –∏–∑ —Å–ø–∏—Å–∫–∞ –∏ –Ω–µ —Ç—ã–∫–Ω—É–ª –∫–∞—Ä—Ç—É
            // –±–µ—Ä–µ–º —Ç–æ, —á—Ç–æ –≤ –∏–Ω–ø—É—Ç–µ
            if (!selectedAddress && searchInput.value) {
                 selectedAddress = searchInput.value;
            }

            if(addrText) addrText.innerText = selectedAddress || "–ê–¥—Ä–µ—Å –Ω–µ –≤—ã–±—Ä–∞–Ω";
            if(summary) summary.classList.remove('translate-y-full');
            
            tg.MainButton.setText("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑");
            tg.MainButton.color = "#34d399"; 
        }

        function hideSummary() {
            const summary = document.getElementById('summary-card');
            if(summary) summary.classList.add('translate-y-full');
            tg.MainButton.setText("–í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å");
            tg.MainButton.color = tg.themeParams.button_color || "#2481cc"; 
        }
        
        async function sendOrder() {
            tg.MainButton.showProgress();
            
            // –ï—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–µ—Ç (–≤–≤–µ–ª —Ä—É–∫–∞–º–∏ –∞–¥—Ä–µ—Å –∏ –Ω–µ –≤—ã–±—Ä–∞–ª –∏–∑ —Å–ø–∏—Å–∫–∞),
            // —à–ª–µ–º 0,0 –∏–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç—å –≤—ã–±—Ä–∞—Ç—å
            const finalLat = selectedCoords ? selectedCoords.lat : 0;
            const finalLng = selectedCoords ? selectedCoords.lng : 0;

            const payload = {
                ...initialOrderData,
                address: selectedAddress,
                latitude: finalLat,
                longitude: finalLng
            };

            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': window.Telegram.WebApp.initData
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    tg.MainButton.hideProgress();
                    window.location.href = "/webapp/orders";
                } else {
                    const err = await response.json();
                    alert("–û—à–∏–±–∫–∞: " + (err.detail || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
                    tg.MainButton.hideProgress();
                }
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + e);
                tg.MainButton.hideProgress();
            }
        }
    });
</script>
{% endblock %}