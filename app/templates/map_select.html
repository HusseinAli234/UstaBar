{% extends "base.html" %}

{% block title %}–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å{% endblock %}

{% block content %}
<div class="relative w-full h-[calc(100vh-20px)] rounded-xl overflow-hidden shadow-lg">
    
    <div class="absolute top-4 left-4 right-4 z-[500]">
        <div class="bg-white dark:bg-gray-800 p-2 rounded-xl shadow-md flex items-center">
            <span class="text-gray-400 pl-2">üìç</span>
            <input type="text" id="address-input" 
                   placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –ø–æ—Å—Ç–∞–≤—å—Ç–µ —Ç–æ—á–∫—É..." 
                   class="w-full bg-transparent border-none focus:ring-0 text-sm text-tg_text placeholder-gray-400 ml-2">
        </div>
    </div>

    <div id="map" class="w-full h-full z-0"></div>

    <div id="summary-card" class="absolute bottom-0 left-0 right-0 z-[500] bg-white dark:bg-gray-900 rounded-t-2xl shadow-[0_-5px_15px_rgba(0,0,0,0.1)] transform translate-y-full transition-transform duration-300 p-5">
        <h3 class="font-bold text-lg mb-3 text-tg_text">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ</h3>
        
        <div class="space-y-2 text-sm text-gray-600 dark:text-gray-300 mb-4">
            <div class="flex justify-between">
                <span>–£—Å–ª—É–≥–∞:</span>
                <span class="font-medium text-tg_text">{{ order_data.service_name }}</span>
            </div>
            <div class="flex justify-between">
                <span>–í—Ä–µ–º—è:</span>
                <span class="font-medium text-tg_text">{{ order_data.duration }} —á.</span>
            </div>
            <div class="flex justify-between">
                <span>–ë—é–¥–∂–µ—Ç:</span>
                <span class="font-medium text-green-600">{{ order_data.price }} ‚ÇΩ</span>
            </div>
            <div class="pt-2 border-t border-gray-100 dark:border-gray-700">
                <span class="block text-xs text-gray-400">–ê–¥—Ä–µ—Å:</span>
                <span id="final-address" class="font-medium text-tg_text">...</span>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}


{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
    
        const tg = window.Telegram.WebApp;
        tg.expand();
    
        
        // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
        tg.BackButton.show();
        tg.BackButton.onClick(() => history.back());

        // –î–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
        const initialOrderData = {{ order_data | tojson }};
    
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentMarker = null;
        let selectedCoords = null;
        let selectedAddress = "";
        

        // === 1. –ö–ê–†–¢–ê ===
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –¢–û–õ–¨–ö–û –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        const map = L.map('map').setView([55.7558, 37.6173], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OSM',
            maxZoom: 19
        }).addTo(map);

        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞: –∏–Ω–æ–≥–¥–∞ –∫–∞—Ä—Ç–∞ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è —Å–µ—Ä—ã–º, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–µ–Ω—è–ª —Ä–∞–∑–º–µ—Ä
        // –î–∞–µ–º –µ–π —Å–µ–∫—É–Ω–¥—É "–ø—Ä–æ–¥—ã—à–∞—Ç—å—Å—è"
        setTimeout(() => {
            map.invalidateSize();
        }, 100);

        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ª–æ–∫–∞—Ü–∏—é
        map.locate({setView: true, maxZoom: 16});
        
        // –°–æ–±—ã—Ç–∏—è –∫–∞—Ä—Ç—ã
        map.on('locationfound', function(e) {
            setPin(e.latlng);
        });
        
        // –ï—Å–ª–∏ –ª–æ–∫–∞—Ü–∏—é –∑–∞–ø—Ä–µ—Ç–∏–ª–∏ –∏–ª–∏ –æ—à–∏–±–∫–∞ - –ø—Ä–æ—Å—Ç–æ –º–æ–ª—á–∏–º (–æ—Å—Ç–∞–µ–º—Å—è –Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö)
        map.on('locationerror', function(e) {
            console.log("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:", e.message);
        });

        map.on('click', function(e) {
            setPin(e.latlng);
        });

        // === 2. –§–£–ù–ö–¶–ò–ò ===

        function setPin(latlng) {
            if (currentMarker) map.removeLayer(currentMarker);
            
            currentMarker = L.marker(latlng).addTo(map);
            selectedCoords = latlng;
            
            map.panTo(latlng); // –ü–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –∫ —Ç–æ—á–∫–µ

            fetchAddress(latlng.lat, latlng.lng);
            
            tg.MainButton.setText("–í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å");
            tg.MainButton.show();
            hideSummary();
        }

        async function fetchAddress(lat, lng) {
            const input = document.getElementById('address-input');
            input.value = "–ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥—Ä–µ—Å–∞..."; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —é–∑–µ—Ä—É, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ–º
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ö–µ–¥–µ—Ä Accept-Language, —á—Ç–æ–±—ã –∞–¥—Ä–µ—Å –ø—Ä–∏—Ö–æ–¥–∏–ª –Ω–∞ —Ä—É—Å—Å–∫–æ–º (–µ—Å–ª–∏ OSM –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç)
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ru`);
                
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—ã–π –∞–¥—Ä–µ—Å
                let shortAddr = data.display_name; // –î–µ—Ñ–æ–ª—Ç
                
                // –ü—ã—Ç–∞–µ–º—Å—è —Å–¥–µ–ª–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–π (–£–ª–∏—Ü–∞, –î–æ–º)
                if (data.address) {
                    const road = data.address.road || data.address.street || "";
                    const number = data.address.house_number || "";
                    if (road) {
                        shortAddr = `${road}${number ? ', ' + number : ''}`;
                    }
                }
                
                selectedAddress = shortAddr;
                input.value = selectedAddress;

            } catch (e) {
                console.error(e);
                input.value = "–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω";
                selectedAddress = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
            }
        }
        
        // === 3. UI ===

        tg.MainButton.onClick(() => {
            // –í–∞–∂–Ω–æ: –ø—Ä–æ–≤–µ—Ä—è–µ–º text, —Ç–∞–∫ –∫–∞–∫ –∫–Ω–æ–ø–∫–∞ –æ–¥–Ω–∞ –Ω–∞ –¥–≤–∞ –¥–µ–π—Å—Ç–≤–∏—è
            if (tg.MainButton.text === "–í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å") {
                showSummary();
            } 
            else if (tg.MainButton.text === "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑") {
                sendOrder();
            }
        });

        function showSummary() {
            const summary = document.getElementById('summary-card');
            const addrText = document.getElementById('final-address');
            
            if(addrText) addrText.innerText = selectedAddress;
            if(summary) summary.classList.remove('translate-y-full');
            
            tg.MainButton.setText("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑");
            tg.MainButton.color = "#34d399"; 
        }

        function hideSummary() {
            const summary = document.getElementById('summary-card');
            if(summary) summary.classList.add('translate-y-full');
            
            tg.MainButton.setText("–í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å");
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ü–≤–µ—Ç –∫–Ω–æ–ø–∫–∏ —Ç–µ–ª–µ–≥—Ä–∞–º–∞
            tg.MainButton.color = tg.themeParams.button_color || "#2481cc"; 
        }
        
        async function sendOrder() {
            tg.MainButton.showProgress();
            
            const payload = {
                ...initialOrderData,
                address: selectedAddress,
                latitude: selectedCoords.lat,
                longitude: selectedCoords.lng
            };

            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    tg.MainButton.hideProgress();
                    tg.close();
                } else {
                    alert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞!");
                    tg.MainButton.hideProgress();
                }
            } catch (e) {
                alert("–û—à–∏–±–∫–∞: " + e);
                tg.MainButton.hideProgress();
            }
        }

        // –†—É—á–Ω–æ–π –≤–≤–æ–¥
        const addrInput = document.getElementById('address-input');
        if (addrInput) {
            addrInput.addEventListener('input', (e) => {
                selectedAddress = e.target.value;
            });
        }
    })
</script>
{% endblock %}