{% extends "base.html" %}

{% block title %}–ó–∞–∫–∞–∑ #{{ order_id }}{% endblock %}

{% block content %}
<div class="flex flex-col h-full pt-4 pb-4 px-4 space-y-4">
    
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-tg_text">–ó–∞–∫–∞–∑ #{{ order_id }}</h1>
        <div id="status-badge" class="px-3 py-1 rounded-lg text-sm font-bold bg-gray-200">...</div>
    </div>

    <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 space-y-3">
        
        <div class="flex justify-between border-b border-gray-100 dark:border-gray-700 pb-2">
            <span class="text-gray-500">–£—Å–ª—É–≥–∞</span>
            <span id="service-name" class="font-medium text-tg_text">...</span>
        </div>
        
        <div class="flex justify-between border-b border-gray-100 dark:border-gray-700 pb-2">
            <span class="text-gray-500">–í—Ä–µ–º—è</span>
            <span id="duration" class="font-medium text-tg_text">...</span>
        </div>

        <div class="flex justify-between border-b border-gray-100 dark:border-gray-700 pb-2">
            <span class="text-gray-500">–ë—é–¥–∂–µ—Ç</span>
            <span id="price" class="font-bold text-green-600 text-lg">...</span>
        </div>

        <div>
            <span class="text-gray-500 text-sm block mb-1">–ê–¥—Ä–µ—Å</span>
            <span id="address" class="font-medium text-tg_text">...</span>
        </div>
    </div>

    <div id="comment-block" class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 hidden">
        <h3 class="text-sm text-gray-500 mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>
        <p id="comment-text" class="text-tg_text"></p>
    </div>

    <div id="photos-block" class="hidden">
        <h3 class="text-sm text-gray-500 mb-2 pl-1">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</h3>
        <div id="photos-grid" class="grid grid-cols-3 gap-2">
            </div>
    </div>
        <div id="worker-info-block" class="hidden mt-4 bg-blue-50 dark:bg-gray-800 border border-blue-200 dark:border-blue-900 rounded-2xl p-4">
        <h3 class="text-sm text-blue-600 font-bold mb-3 uppercase tracking-wider">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</h3>
        
        <div class="flex items-center space-x-3 mb-4">
            <div class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center text-xl font-bold">
                <span id="worker-avatar">üë§</span>
            </div>
            <div>
                <div id="worker-name" class="font-bold text-lg text-tg_text">–ò–º—è –ú–∞—Å—Ç–µ—Ä–∞</div>
                <div id="worker-username" class="text-sm text-gray-500">@username</div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-4">
            <a id="btn-call" href="#" class="flex items-center justify-center py-2 bg-white dark:bg-gray-700 rounded-xl shadow-sm font-medium text-tg_text">
                üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å
            </a>
            <a id="btn-telegram" href="#" class="flex items-center justify-center py-2 bg-blue-500 text-white rounded-xl shadow-sm font-medium">
                ‚úàÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å
            </a>
        </div>

        <button onclick="completeOrder()" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl shadow-lg shadow-green-500/30 transition-transform active:scale-95">
            ‚úÖ –ó–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω
        </button>
    </div>

    <div id="applications-section" class="hidden mt-6">
        <h3 class="text-lg font-bold text-tg_text mb-3 flex items-center">
            –û—Ç–∫–ª–∏–∫–∏ –º–∞—Å—Ç–µ—Ä–æ–≤
            <span id="apps-count" class="ml-2 bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full">0</span>
        </h3>
        
        <div id="applications-list" class="space-y-3 pb-20">
            </div>
    </div>

    <button id="cancel-btn" class="w-full py-3 rounded-xl bg-red-50 text-red-600 font-medium hidden">
        –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
    </button>

</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {

    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.BackButton.show();
    tg.BackButton.onClick(() => window.history.back());

    const orderId = {{ order_id }};
    
    // –°–ª–æ–≤–∞—Ä–∏
    const STATUS_COLORS = {'searching': 'bg-yellow-100 text-yellow-800', 'in_progress': 'bg-blue-100 text-blue-800', 'completed': 'bg-green-100 text-green-800', 'canceled': 'bg-gray-100 text-gray-800'};
    const STATUS_NAMES = {'searching': '–ü–æ–∏—Å–∫', 'in_progress': '–í —Ä–∞–±–æ—Ç–µ', 'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω', 'canceled': '–û—Ç–º–µ–Ω–µ–Ω'};

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    async function loadDetails() {
        try {
            const response = await fetch(`/api/orders/${orderId}`, {
                headers: { 'Authorization': tg.initData }
            });
            
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            const order = await response.json();

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—Å—Ç—ã
            document.getElementById('service-name').innerText = order.service_type;
            document.getElementById('duration').innerText = order.duration + ' —á.';
            document.getElementById('price').innerText = order.price + ' ‚ÇΩ';
            document.getElementById('address').innerText = order.address;

            // –°—Ç–∞—Ç—É—Å
            const badge = document.getElementById('status-badge');
            badge.className = `px-3 py-1 rounded-lg text-sm font-bold ${STATUS_COLORS[order.status]}`;
            badge.innerText = STATUS_NAMES[order.status];

            // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            if (order.comment) {
                document.getElementById('comment-block').classList.remove('hidden');
                document.getElementById('comment-text').innerText = order.comment;
            }

            // –§–æ—Ç–æ (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if (order.photos && order.photos.length > 0) {
                document.getElementById('photos-block').classList.remove('hidden');
                // ... —Ç—É—Ç –≤–∞—à –∫–æ–¥ —Ä–µ–Ω–¥–µ—Ä–∞ —Ñ–æ—Ç–æ ...
            }

            // === –ì–õ–ê–í–ù–û–ï: –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ –û–¢–ú–ï–ù–´ ===
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 'searching'
            if (order.status === 'searching') {
                loadApplications(orderId);
                const btn = document.getElementById('cancel-btn');
                btn.classList.remove('hidden');
                
                // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                btn.onclick = () => handleCancelOrder();
            }
            if (order.status === 'in_progress' && order.worker) {
            document.getElementById('worker-info-block').classList.remove('hidden');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–º–µ–Ω—ã –∏ —Å–ø–∏—Å–æ–∫ –æ—Ç–∫–ª–∏–∫–æ–≤ (–æ–Ω–∏ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã)
            document.getElementById('cancel-btn').classList.add('hidden');
            document.getElementById('applications-section').classList.add('hidden');

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            document.getElementById('worker-name').innerText = order.worker.name;
            document.getElementById('worker-avatar').innerText = order.worker.name[0];
            
            const username = order.worker.username ? `@${order.worker.username}` : '–ù–µ—Ç –Ω–∏–∫–Ω–µ–π–º–∞';
            document.getElementById('worker-username').innerText = username;

            // –°—Å—ã–ª–∫–∏
            if (order.worker.phone) {
                document.getElementById('btn-call').href = `tel:${order.worker.phone}`;
            } else {
                document.getElementById('btn-call').classList.add('opacity-50', 'pointer-events-none');
            }

            if (order.worker.username) {
                document.getElementById('btn-telegram').href = `https://t.me/${order.worker.username}`;
            } else {
                document.getElementById('btn-telegram').classList.add('hidden');
            }
        }

        } catch (e) {
            tg.showAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏: " + e.message);
        }
    }
    window.completeOrder = function() {
        tg.showConfirm("–í—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ, —á—Ç–æ —Ä–∞–±–æ—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∏ –≤—ã –æ–ø–ª–∞—Ç–∏–ª–∏ –∑–∞–∫–∞–∑?", async (ok) => {
            if (!ok) return;

            tg.MainButton.showProgress();
            try {
                const res = await fetch(`/api/orders/${orderId}/complete`, {
                    method: 'POST',
                    headers: { 'Authorization': tg.initData }
                });
                
                if (res.ok) {
                    tg.MainButton.hideProgress();
                    tg.showAlert("–û—Ç–ª–∏—á–Ω–æ! –ó–∞–∫–∞–∑ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –≤ –∞—Ä—Ö–∏–≤.");
                    window.location.reload(); 
                }
            } catch (e) {
                tg.MainButton.hideProgress();
                tg.showAlert("–û—à–∏–±–∫–∞");
            }
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞
    function handleCancelOrder() {
        tg.showConfirm("–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?", async (confirmed) => {
            if (!confirmed) return;

            try {
                tg.MainButton.showProgress();
                
                const response = await fetch(`/api/orders/${orderId}/cancel`, {
                    method: 'POST',
                    headers: { 'Authorization': tg.initData }
                });

                if (response.ok) {
                    tg.MainButton.hideProgress();
                    tg.showAlert("–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω!");
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏–ª—Å—è —Å—Ç–∞—Ç—É—Å
                    window.location.reload(); 
                } else {
                    const err = await response.json();
                    throw new Error(err.detail || "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
                }
            } catch (e) {
                tg.MainButton.hideProgress();
                tg.showAlert("–û—à–∏–±–∫–∞: " + e.message);
            }
        });
    }

    async function loadApplications(id) {
        try {
            const response = await fetch(`/api/orders/${id}/applications`, {
                headers: { 'Authorization': tg.initData }
            });
            const apps = await response.json();

            if (apps.length > 0) {
                document.getElementById('applications-section').classList.remove('hidden');
                document.getElementById('apps-count').innerText = apps.length;
                
                const list = document.getElementById('applications-list');
                list.innerHTML = '';

                apps.forEach(app => {
                    const price = app.proposed_price ? app.proposed_price + ' ‚ÇΩ' : '–ü–æ –ø—Ä–∞–π—Å—É';
                    const rating = app.worker.rating || '5.0';
                    
                    const card = document.createElement('div');
                    card.className = "bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col";
                    
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-blue-400 to-purple-500 text-white flex items-center justify-center font-bold">
                                    ${app.worker.name[0]}
                                </div>
                                <div>
                                    <h4 class="font-bold text-tg_text">${app.worker.name}</h4>
                                    <div class="flex items-center text-xs text-yellow-500">
                                        ‚≠ê ${rating}
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="block font-bold text-tg_text">${price}</span>
                            </div>
                        </div>
                        
                        <div class="mt-3 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-sm text-gray-600 dark:text-gray-300 italic">
                            "${app.message || '–ì–æ—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞—Ç—å'}"
                        </div>
                        
                        <button onclick="acceptWorker(${app.id}, '${app.worker.name}')" class="mt-3 w-full py-2 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg transition-colors">
                            –í—ã–±—Ä–∞—Ç—å –º–∞—Å—Ç–µ—Ä–∞
                        </button>
                    `;
                    list.appendChild(card);
                });
            }
        } catch (e) {
            console.error(e);
        }
    }

    // –§–£–ù–ö–¶–ò–Ø –ü–†–ò–ù–Ø–¢–ò–Ø
window.acceptWorker = function(appId, name) {
        tg.showConfirm(`–ù–∞–Ω—è—Ç—å –º–∞—Å—Ç–µ—Ä–∞ ${name}? –ó–∞–∫–∞–∑ –ø–µ—Ä–µ–π–¥–µ—Ç –≤ —Å—Ç–∞—Ç—É—Å "–í —Ä–∞–±–æ—Ç–µ".`, async (ok) => {
            if (!ok) return;
            
            tg.MainButton.showProgress();
            try {
                const res = await fetch(`/api/orders/${orderId}/accept/${appId}`, {
                    method: 'POST',
                    headers: { 'Authorization': tg.initData }
                });
                
                if (res.ok) {
                    tg.MainButton.hideProgress();
                    tg.showAlert("–ú–∞—Å—Ç–µ—Ä –≤—ã–±—Ä–∞–Ω! –°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∏–º.");
                    window.location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
                }
            } catch (e) {
                tg.MainButton.hideProgress();
                tg.showAlert("–û—à–∏–±–∫–∞");
            }
        });
    }
    loadDetails();
});
</script>
{% endblock %}