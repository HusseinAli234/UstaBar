{% extends "base.html" %}

{% block title %}–ú–æ–∏ –∑–∞–∫–∞–∑—ã{% endblock %}

{% block content %}
<div class="flex flex-col h-full pt-4 pb-20"> <div class="px-4 mb-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-tg_text">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h1>
        <button onclick="loadOrders()" class="p-2 bg-gray-100 dark:bg-gray-800 rounded-full text-blue-500">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
        </button>
    </div>

    <div id="orders-container" class="space-y-3 px-4 overflow-y-auto custom-scrollbar">
        <div class="animate-pulse space-y-3">
            <div class="h-24 bg-gray-200 dark:bg-gray-800 rounded-xl"></div>
            <div class="h-24 bg-gray-200 dark:bg-gray-800 rounded-xl"></div>
        </div>
    </div>

    <div id="empty-state" class="hidden flex-col items-center justify-center h-64 text-center">
        <div class="text-6xl mb-4">üì¶</div>
        <h3 class="text-lg font-medium text-tg_text">–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h3>
        <p class="text-gray-500 text-sm mt-1">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</p>
    </div>

</div>

<div class="fixed bottom-4 right-4 z-50">
    <a href="/webapp/select-service" class="flex items-center justify-center w-14 h-14 bg-blue-500 hover:bg-blue-600 text-white rounded-full shadow-lg transition-transform hover:scale-105 active:scale-95">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {

    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.BackButton.hide();

    // –°–ª–æ–≤–∞—Ä–∏ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
    const SERVICE_ICONS = {'cleaning': 'üßπ', 'electrician': '‚ö°', 'plumber': 'üîß', 'nanny': 'üß∏', 'other': 'üì¶'};
    const STATUS_COLORS = {'searching': 'bg-yellow-100 text-yellow-800', 'in_progress': 'bg-blue-100 text-blue-800', 'completed': 'bg-green-100 text-green-800', 'canceled': 'bg-gray-100 text-gray-800'};
    const STATUS_NAMES = {'searching': '–ü–æ–∏—Å–∫', 'in_progress': '–í —Ä–∞–±–æ—Ç–µ', 'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω', 'canceled': '–û—Ç–º–µ–Ω–µ–Ω'};

      window.loadOrders = async function() {
        const container = document.getElementById('orders-container');
        
        // 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–ª–µ—Ä—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (—É–±–µ—Ä–∏—Ç–µ –ø–æ—Ç–æ–º)

        try {
            // –†–∏—Å—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            container.innerHTML = `<div class="animate-pulse space-y-3"><div class="h-24 bg-gray-200 dark:bg-gray-800 rounded-xl"></div></div>`;

            // 2. –î–æ–±–∞–≤–ª—è–µ–º ?v=... —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –Ω–µ –±—Ä–∞–ª –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–µ—à–∞
            const response = await fetch('/api/orders/my?v=' + Date.now(), {
                headers: { 'Authorization': tg.initData }
            });

            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞: ' + response.status);
            
            const orders = await response.json();
            console.log(orders)
            container.innerHTML = ''; // –£–±–∏—Ä–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É

            if (orders.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                document.getElementById('empty-state').classList.add('flex');
                return;
            }

            orders.forEach(order => {
                const sType = order.service_type || 'other';
                const icon = SERVICE_ICONS[sType] || 'üì¶';
                const serviceName = sType.charAt(0).toUpperCase() + sType.slice(1);
                const statusName = STATUS_NAMES[order.status] || order.status;
                const price = order.price + ' ‚ÇΩ';
                
                // –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏
                const card = document.createElement('div');
                // –î–æ–±–∞–≤–ª—è–µ–º cursor-pointer –∏ active —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏
                card.className = "bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 mb-3 cursor-pointer active:scale-95 transition-transform";

                // --- –î–û–ë–ê–í–õ–Ø–ï–ú –ü–ï–†–ï–•–û–î ---
                card.onclick = function() {
                    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–µ—Ç–∞–ª–µ–π
                    window.location.href = `/webapp/orders/${order.id}`;
                };
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full bg-blue-50 dark:bg-gray-700 flex items-center justify-center text-xl">${icon}</div>
                            <div>
                                <h3 class="font-bold text-tg_text text-lg">${serviceName}</h3>
                                <p class="text-xs text-gray-400">#${order.id}</p>
                            </div>
                        </div>
                        <span class="px-2 py-1 rounded-lg text-xs font-bold ${STATUS_COLORS[order.status]}">${statusName}</span>
                    </div>
                    <div class="flex justify-between items-end mt-2">
                        <div class="text-sm text-gray-500 truncate w-1/2">${order.address}</div>
                        <div class="font-bold text-lg text-tg_text">${price}</div>
                    </div>
                `;
                container.appendChild(card);
            });

        } catch (e) {
            // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –ø–æ–∫–∞–∂–µ–º –µ—ë –ø—Ä—è–º–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
            container.innerHTML = `<div class="p-4 bg-red-500 text-white rounded-xl">–û—à–∏–±–∫–∞: ${e.message}</div>`;
        }
    }

    loadOrders()
});
    

</script>

{% endblock %}