{% extends "base.html" %}

{% block title %}–ú–æ–∏ –∑–∞–∫–∞–∑—ã{% endblock %}

{% block content %}
<div class="flex flex-col h-full pt-4 pb-20"> <div class="px-4 mb-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-tg_text">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h1>
        <button onclick="loadOrders()" class="p-2 bg-gray-100 dark:bg-gray-800 rounded-full text-blue-500">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
        </button>
    </div>

    <div id="orders-container" class="space-y-3 px-4 overflow-y-auto custom-scrollbar">
        <div class="animate-pulse space-y-3">
            <div class="h-24 bg-gray-200 dark:bg-gray-800 rounded-xl"></div>
            <div class="h-24 bg-gray-200 dark:bg-gray-800 rounded-xl"></div>
        </div>
    </div>

    <div id="empty-state" class="hidden flex-col items-center justify-center h-64 text-center">
        <div class="text-6xl mb-4">üì¶</div>
        <h3 class="text-lg font-medium text-tg_text">–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h3>
        <p class="text-gray-500 text-sm mt-1">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</p>
    </div>

</div>

<div class="fixed bottom-4 right-4 z-50">
    <a href="/webapp/select-service" class="flex items-center justify-center w-14 h-14 bg-blue-500 hover:bg-blue-600 text-white rounded-full shadow-lg transition-transform hover:scale-105 active:scale-95">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.BackButton.hide();

    // –°–ª–æ–≤–∞—Ä–∏–∫ –∏–∫–æ–Ω–æ–∫ –∏ —Ü–≤–µ—Ç–æ–≤
    const SERVICE_ICONS = {
        'cleaning': 'üßπ', 'electrician': '‚ö°', 'plumber': 'üîß', 'nanny': 'üß∏', 'other': 'üì¶'
    };
    const STATUS_COLORS = {
        'searching': 'bg-yellow-100 text-yellow-800 border-yellow-200',
        'in_progress': 'bg-blue-100 text-blue-800 border-blue-200',
        'completed': 'bg-green-100 text-green-800 border-green-200',
        'canceled': 'bg-gray-100 text-gray-800 border-gray-200'
    };
    const STATUS_NAMES = {
        'searching': '–ü–æ–∏—Å–∫ –º–∞—Å—Ç–µ—Ä–∞', 'in_progress': '–í —Ä–∞–±–æ—Ç–µ',
        'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω', 'canceled': '–û—Ç–º–µ–Ω–µ–Ω'
    };

    // 1. –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ì–õ–û–ë–ê–õ–¨–ù–û–ô (–≤–Ω–µ –≤—Å—è–∫–∏—Ö —Å–∫–æ–±–æ–∫)
    async function loadOrders() {
        const container = document.getElementById('orders-container');
        const emptyState = document.getElementById('empty-state');
        
        try {
            // –†–∏—Å—É–µ–º —Å–∫–µ–ª–µ—Ç–æ–Ω (–∑–∞–≥—Ä—É–∑–∫—É) –ø–æ–∫–∞ –∂–¥–µ–º
            container.innerHTML = `
                <div class="animate-pulse space-y-3">
                    <div class="h-24 bg-gray-200 dark:bg-gray-800 rounded-xl"></div>
                </div>`;

            const response = await fetch('/api/orders/my', {
                headers: { 'Authorization': tg.initData }
            });

            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + response.status);
            
            const orders = await response.json();
            console.log("–î–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞:", orders); // –°–º–æ—Ç—Ä–∏–º –≤ Eruda

            container.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–∫–µ–ª–µ—Ç–æ–Ω

            if (orders.length === 0) {
                emptyState.classList.remove('hidden');
                emptyState.classList.add('flex');
                return;
            } else {
                emptyState.classList.add('hidden');
                emptyState.classList.remove('flex');
            }

            orders.forEach(order => {
                // –ó–∞—â–∏—Ç–∞ –æ—Ç undefined –ø–æ–ª–µ–π
                const sType = order.service_type || 'other';
                const sStatus = order.status || 'searching';
                
                const icon = SERVICE_ICONS[sType] || 'üî®';
                const serviceName = (sType.charAt(0).toUpperCase() + sType.slice(1)); 
                const statusClass = STATUS_COLORS[sStatus] || STATUS_COLORS['searching'];
                const statusName = STATUS_NAMES[sStatus] || sStatus;
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É –∏ –¥–∞—Ç—É
                const price = order.price ? `${order.price} ‚ÇΩ` : '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è';
                const address = order.address || '–ê–¥—Ä–µ—Å —Å–∫—Ä—ã—Ç';
                
                // –ü–æ–ø—ã—Ç–∫–∞ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –¥–∞—Ç—É
                let dateStr = '';
                if (order.created_at) {
                    dateStr = new Date(order.created_at).toLocaleDateString('ru-RU', {day: 'numeric', month: 'long'});
                }

                const card = document.createElement('div');
                card.className = "bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 active:scale-[0.98] transition-transform cursor-pointer";
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full bg-blue-50 dark:bg-gray-700 flex items-center justify-center text-xl">
                                ${icon}
                            </div>
                            <div>
                                <h3 class="font-bold text-tg_text text-lg leading-tight">${serviceName}</h3>
                                <p class="text-xs text-gray-400">${dateStr}</p>
                            </div>
                        </div>
                        <span class="px-2.5 py-1 rounded-lg text-xs font-semibold border ${statusClass}">
                            ${statusName}
                        </span>
                    </div>
                    
                    <div class="flex justify-between items-end mt-3">
                        <div class="text-sm text-gray-500 dark:text-gray-400 truncate max-w-[150px]">
                            ${address}
                        </div>
                        <div class="font-bold text-lg text-tg_text">
                            ${price}
                        </div>
                    </div>
                `;
                
                // –ö–ª–∏–∫ - –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –∞–ª–µ—Ä—Ç
                card.onclick = () => tg.showAlert(`–ó–∞–∫–∞–∑ #${order.id}`);
                container.appendChild(card);
            });

        } catch (e) {
            console.error(e);
            container.innerHTML = `<div class="text-red-500 text-center p-4">–û—à–∏–±–∫–∞: ${e.message}</div>`;
        }
    }

    // 2. –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É, –∫–æ–≥–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≥–æ—Ç–æ–≤–∞
    document.addEventListener('DOMContentLoaded', loadOrders);

</script>
<script src="//cdn.jsdelivr.net/npm/eruda"></script>
<script>eruda.init();</script>
{% endblock %}